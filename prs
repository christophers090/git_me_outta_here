#!/usr/bin/env bash
set -euo pipefail

# Resolve script directory for sourcing library files
SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"

# Source configuration and helpers
source "$SCRIPT_DIR/prs.d/config.sh"
source "$SCRIPT_DIR/prs.d/helpers.sh"
source "$SCRIPT_DIR/prs.d/helpers_cache.sh"
source "$SCRIPT_DIR/prs.d/helpers_comments.sh"
source "$SCRIPT_DIR/prs.d/helpers_buildkite.sh"

# Usage
usage() {
  echo -e "${BOLD}Usage:${NC} prs [OPTIONS] [TOPIC]"
  echo ""
  echo -e "${BOLD}Options:${NC}"
  echo "  -o, --outstanding  Show outstanding PRs (default)"
  echo "  -s, --status       Show detailed status for a PR"
  echo "  -d, --diff         Show diff for a PR"
  echo "  -f, --files        List changed files in a PR"
  echo "  -m, --merge        Add PR to merge queue (must target main)"
  echo "  -rq                Remove PR from merge queue"
  echo "  -qs                Show all PRs in merge queue"
  echo "  -c, --comments     Show unresolved comments on a PR"
  echo "  -csr               Show all comments including resolved"
  echo "  -cr <topic> <#>    Reply to comment #"
  echo "  -crx <topic> <#>   Reply and resolve comment #"
  echo "  -ct <topic> <#>    Thumbs up comment #"
  echo "  -ctx <topic> <#>   Thumbs up and resolve comment #"
  echo "  -cx <topic> <#>    Resolve comment thread #"
  echo "  --close            Close a PR"
  echo "  --open             Reopen a closed PR"
  echo "  --closed           Show recent closed PRs"
  echo "  --merged           Show recent merged PRs"
  echo "  -w, --web          Open GitHub PR in browser"
  echo "  -bw                Open Buildkite CI in browser"
  echo "  -b, -bs            Show build steps status"
  echo "  -bc <topic> <#>    Cancel a buildkite job"
  echo "  -br <topic> <#>    Retry a buildkite job"
  echo "  -brf <topic>       Retry all failed jobs"
  echo "  -bcon <topic> <#> [-n N]  Show last N lines of job output (default 10)"
  echo "  -y, --yank         Copy PR title and URL to clipboard"
  echo "  -u, --user USER    Use a different user (default: you)"
  echo "  -h, --help         Show this help"
  echo ""
  echo -e "${BOLD}Examples:${NC}"
  echo "  prs                # List all outstanding PRs"
  echo "  prs my_feature           # Detailed status for 'my_feature' PR (same as -s)"
  echo "  prs this           # Show PRs for current worktree"
  echo "  prs -s my_feature        # Detailed status for 'my_feature' PR"
  echo "  prs -d my_feature       # Show diff for 'my_feature' PR"
  echo "  prs -f my_feature       # List files changed in 'my_feature' PR"
  echo "  prs -m my_feature       # Add 'my_feature' PR to merge queue"
  echo "  prs -c my_feature       # Show unresolved comments on 'my_feature' PR"
  echo "  prs -csr my_feature     # Show all comments including resolved"
  echo "  prs -cr my_feature 2     # Reply to comment #2 on 'my_feature' PR"
  echo "  prs -ct my_feature 3     # Thumbs up comment #3 on 'my_feature' PR"
  echo "  prs -cx my_feature 1     # Resolve comment thread #1 on 'my_feature' PR"
  echo "  prs --close my_feature  # Close 'my_feature' PR"
  echo "  prs -w my_feature       # Open 'my_feature' PR on GitHub"
  echo "  prs -bw my_feature      # Open Buildkite for 'my_feature' PR"
  echo "  prs -b my_feature       # Show build steps for 'my_feature' PR"
  echo "  prs -bc my_feature 7     # Cancel job #7 for 'my_feature' PR"
  echo "  prs -br my_feature 7     # Retry job #7 for 'my_feature' PR"
  echo "  prs -brf my_feature     # Retry all failed jobs for 'my_feature' PR"
  echo "  prs -bcon my_feature 7   # Show last 10 lines of job #7 output"
  echo "  prs -bcon my_feature 7 -n 50  # Show last 50 lines"
  echo "  prs -rq my_feature      # Remove 'my_feature' PR from merge queue"
  echo "  prs -qs            # Show all PRs in merge queue"
  echo "  prs --closed       # Show recent closed PRs"
  echo "  prs --merged       # Show recent merged PRs"
  echo "  prs --open my_feature   # Reopen 'my_feature' PR"
  echo "  prs -y my_feature       # Show 'my_feature' PR and copy title+URL to clipboard"
  echo ""
  echo -e "${BOLD}Quick Start:${NC}"
  echo "  prs                     # List your open PRs"
  echo "  prs my_feature          # Show status of a PR"
  echo "  prs -b my_feature       # Show build steps"
  exit 0
}

# Parse arguments
MODE="outstanding"
TOPIC=""
EXTRA_ARGS=()
COPY_TO_CLIPBOARD=false

while [[ $# -gt 0 ]]; do
  case "$1" in
  -o | --outstanding)
    MODE="outstanding"
    shift
    ;;
  -s | --status)
    MODE="status"
    shift
    ;;
  -d | --diff)
    MODE="diff"
    shift
    ;;
  -f | --files)
    MODE="files"
    shift
    ;;
  -m | --merge)
    MODE="merge"
    shift
    ;;
  -c | --comments)
    MODE="comments"
    shift
    ;;
  -csr)
    MODE="comments"
    EXTRA_ARGS+=("--show-resolved")
    shift
    ;;
  -cr)
    MODE="comment_reply"
    shift
    ;;
  -crx)
    MODE="comment_reply_resolve"
    shift
    ;;
  -ct)
    MODE="comment_thumbsup"
    shift
    ;;
  -ctx)
    MODE="comment_thumbsup_resolve"
    shift
    ;;
  -cx)
    MODE="comment_resolve"
    shift
    ;;
  --close)
    MODE="close"
    shift
    ;;
  -w | --web)
    MODE="web"
    shift
    ;;
  -bw)
    MODE="buildkite"
    shift
    ;;
  -b | -bs)
    MODE="build_steps"
    shift
    ;;
  -bc)
    MODE="build_cancel"
    shift
    ;;
  -br)
    MODE="build_retry"
    shift
    ;;
  -brf)
    MODE="build_retry_failed"
    shift
    ;;
  -bcon)
    MODE="build_console"
    shift
    ;;
  -rq)
    MODE="remove_queue"
    shift
    ;;
  -qs)
    MODE="queue_status"
    shift
    ;;
  --open)
    MODE="reopen"
    shift
    ;;
  --closed)
    MODE="closed"
    shift
    ;;
  --merged)
    MODE="merged"
    shift
    ;;
  -y | --yank)
    COPY_TO_CLIPBOARD=true
    shift
    ;;
  -u | --user)
    GITHUB_USER="$2"
    BRANCH_USER="$2"
    shift 2
    ;;
  -h | --help)
    usage
    ;;
  -n)
    # Sub-flag for modes like -bcon
    if [[ -n "$TOPIC" ]]; then
      EXTRA_ARGS+=("$1" "$2")
      shift 2
    else
      echo -e "${RED}Unknown option:${NC} $1"
      exit 1
    fi
    ;;
  -*)
    echo -e "${RED}Unknown option:${NC} $1"
    exit 1
    ;;
  *)
    if [[ -z "$TOPIC" ]]; then
      TOPIC="$1"
    else
      EXTRA_ARGS+=("$1")
    fi
    shift
    ;;
  esac
done

# If topic provided without explicit mode flag, default to status mode
if [[ "$MODE" == "outstanding" && -n "$TOPIC" ]]; then
  MODE="status"
fi

# Export for mode scripts
export COPY_TO_CLIPBOARD

# Source and run mode
source "$SCRIPT_DIR/prs.d/mode_${MODE}.sh"
"run_${MODE}" "$TOPIC" "${EXTRA_ARGS[@]}"
