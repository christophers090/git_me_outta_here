#!/usr/bin/env bash
set -euo pipefail

# Resolve script directory for sourcing library files
SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"

# Source configuration and helpers
source "$SCRIPT_DIR/prs.d/config.sh"
source "$SCRIPT_DIR/prs.d/helpers.sh"
source "$SCRIPT_DIR/prs.d/helpers_cache.sh"
source "$SCRIPT_DIR/prs.d/helpers_comments.sh"
source "$SCRIPT_DIR/prs.d/helpers_comment_modes.sh"
source "$SCRIPT_DIR/prs.d/helpers_buildkite.sh"

# Usage
usage() {
  echo -e "${BOLD}Usage:${NC} prs [OPTIONS] [TOPIC]"
  echo ""
  echo -e "${BOLD}PR Status & Navigation${NC}"
  echo "  prs                      List all your open PRs with CI/review status"
  echo "  prs <topic>              Show detailed status for a PR (CI, reviews, merge state)"
  echo "  prs --this               Show PRs for revup topics in current branch"
  echo "  -s, --status <topic>     Explicit status view (same as prs <topic>)"
  echo "  -d, --diff <topic>       Show the diff for a PR"
  echo "  -f, --files <topic>      List files changed in a PR"
  echo "  -w, --web <topic>        Open the PR on GitHub in your browser"
  echo "  -y, --yank <topic>       Copy PR number, title, and URL to clipboard"
  echo ""
  echo -e "${BOLD}PR Lifecycle${NC}"
  echo "  -m, --merge <topic>      Add PR to GitHub merge queue (requires main target)"
  echo "  -rq <topic>              Remove PR from merge queue"
  echo "  -q, -qs                  Show all PRs currently in merge queue"
  echo "  --close <topic>          Close a PR without merging"
  echo "  --open <topic>           Reopen a previously closed PR"
  echo "  --closed                 List your recently closed PRs"
  echo "  --merged                 List your recently merged PRs"
  echo ""
  echo -e "${BOLD}Review Comments${NC}"
  echo "  -c, --comments <topic>   Show unresolved review comments (numbered for actions)"
  echo "  -csr <topic>             Show all comments including resolved threads"
  echo "  -cx <topic> <#>          Resolve comment thread by number"
  echo "  -ct <topic> <#>          Add thumbs-up reaction to acknowledge comment"
  echo "  -ctx <topic> <#>         Thumbs-up and resolve in one action"
  echo "  -cr <topic> <#>          Reply to a comment (opens editor for input)"
  echo "  -crx <topic> <#>         Reply and resolve thread in one action"
  echo ""
  echo -e "${BOLD}Buildkite CI${NC}"
  echo "  -b, -bs <topic>          Show build steps with pass/fail/pending status"
  echo "  -bw <topic>              Open Buildkite build page in browser"
  echo "  -br <topic> <#>          Retry a specific failed job by step number"
  echo "  -brf <topic>             Retry all failed jobs in the build"
  echo "  -bc <topic> <#>          Cancel a running job by step number"
  echo "  -bcon <topic> <#>        Show console output (last 10 lines by default)"
  echo "  -bcon <topic> <#> -n N   Show last N lines of console output"
  echo ""
  echo -e "${BOLD}Other Options${NC}"
  echo "  -u, --user <username>    Query PRs for a different GitHub user"
  echo "  -h, --help               Show this help message"
  echo ""
  echo -e "${BOLD}Examples${NC}"
  echo "  prs                        List open PRs with CI and review status"
  echo "  prs --this                 Show PRs for topics in your current branch"
  echo "  prs my-feature             Full status: CI checks, reviews, merge readiness"
  echo "  prs -c my-feature          See unresolved comments numbered #1, #2, etc."
  echo "  prs -ctx my-feature 2      Acknowledge and resolve comment #2"
  echo "  prs -b my-feature          View all build steps and their status"
  echo "  prs -brf my-feature        Retry all failed CI jobs"
  echo "  prs -m my-feature          Queue PR for merge when checks pass"
  exit 0
}

# Parse arguments
MODE="outstanding"
TOPIC=""
EXTRA_ARGS=()
COPY_TO_CLIPBOARD=false
THIS_MODE=false

while [[ $# -gt 0 ]]; do
  case "$1" in
  -o | --outstanding)
    MODE="outstanding"
    shift
    ;;
  --this)
    MODE="outstanding"
    THIS_MODE=true
    shift
    ;;
  -s | --status)
    MODE="status"
    shift
    ;;
  -d | --diff)
    MODE="diff"
    shift
    ;;
  -f | --files)
    MODE="files"
    shift
    ;;
  -m | --merge)
    MODE="merge"
    shift
    ;;
  -c | --comments)
    MODE="comments"
    shift
    ;;
  -csr)
    MODE="comments"
    EXTRA_ARGS+=("--show-resolved")
    shift
    ;;
  -cr)
    MODE="comment_reply"
    shift
    ;;
  -crx)
    MODE="comment_reply_resolve"
    shift
    ;;
  -ct)
    MODE="comment_thumbsup"
    shift
    ;;
  -ctx)
    MODE="comment_thumbsup_resolve"
    shift
    ;;
  -cx)
    MODE="comment_resolve"
    shift
    ;;
  --close)
    MODE="close"
    shift
    ;;
  -w | --web)
    MODE="web"
    shift
    ;;
  -bw)
    MODE="buildkite"
    shift
    ;;
  -b | -bs)
    MODE="build_steps"
    shift
    ;;
  -bc)
    MODE="build_cancel"
    shift
    ;;
  -br)
    MODE="build_retry"
    shift
    ;;
  -brf)
    MODE="build_retry_failed"
    shift
    ;;
  -bcon)
    MODE="build_console"
    shift
    ;;
  -rq)
    MODE="remove_queue"
    shift
    ;;
  -q|-qs)
    MODE="queue_status"
    shift
    ;;
  --open)
    MODE="reopen"
    shift
    ;;
  --closed)
    MODE="closed"
    shift
    ;;
  --merged)
    MODE="merged"
    shift
    ;;
  -y | --yank)
    COPY_TO_CLIPBOARD=true
    shift
    ;;
  -u | --user)
    GITHUB_USER="$2"
    BRANCH_USER="$2"
    shift 2
    ;;
  -h | --help)
    usage
    ;;
  -n)
    # Sub-flag for modes like -bcon
    if [[ -n "$TOPIC" ]]; then
      EXTRA_ARGS+=("$1" "$2")
      shift 2
    else
      echo -e "${RED}Unknown option:${NC} $1"
      exit 1
    fi
    ;;
  -*)
    echo -e "${RED}Unknown option:${NC} $1"
    exit 1
    ;;
  *)
    if [[ -z "$TOPIC" ]]; then
      TOPIC="$1"
    else
      EXTRA_ARGS+=("$1")
    fi
    shift
    ;;
  esac
done

# If topic provided without explicit mode flag, default to status mode
if [[ "$MODE" == "outstanding" && -n "$TOPIC" ]]; then
  MODE="status"
fi

# Handle --this flag for outstanding mode
if [[ "$THIS_MODE" == "true" ]]; then
  TOPIC="this"
fi

# Export for mode scripts
export COPY_TO_CLIPBOARD

# Source and run mode
source "$SCRIPT_DIR/prs.d/mode_${MODE}.sh"
"run_${MODE}" "$TOPIC" "${EXTRA_ARGS[@]}"
